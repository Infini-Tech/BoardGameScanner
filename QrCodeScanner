using UnityEngine;
using System.Collections;
using UnityEngine.UI;

public class QrCodeScanner : MonoBehaviour {
	//myDebug is her to help figure out where the problems are while testing on my mobile device.

	private WebcamWrapper 
		myWrapper;

	public GameObject
		myCameraPlane;

	public Toggle
		myStartSearch;

	public Text
		myText,
		myDebug;

	private string 
		myContent;

	private bool
		isScanning;

	public virtual void Awake(){
		myWrapper = new WebcamWrapper ();
		myWrapper.StartCamera ();
		myWrapper.Paint (myCameraPlane);
		isScanning = false;
		myStartSearch.isOn = false;
		myDebug.text = "Awake";


	}
	public virtual void Update(){
		if (!isScanning && myStartSearch.isOn) {
			myDebug.text = "Start Scan";
			StartCoroutine(Scan ());
		}
		if (isScanning && !myStartSearch.isOn) {
			myDebug.text = "Fixing Dirty Scan";
			isScanning = false;
			myDebug.text = "Dirty Camera Restarted";
			myWrapper.StartCamera();
		}
	}

	public float ScanDelay;

	public IEnumerator Scan(){
		myDebug.text = "Scan Began";
		isScanning = true;
		bool hasFound = false;
		while (myStartSearch.isOn && !hasFound) {
			myDebug.text = "Scan Start Cycle";
			myDebug.text = "Pause Camera";
			myWrapper.PauseCamera ();
			myDebug.text = "Scan";
			Texture2D scan = myWrapper.GetPicture ();
			myDebug.text = "Camera Restarted";
			myWrapper.StartCamera();
			myDebug.text = "Check Scan";

			if(scan != null){
				myDebug.text = "Analyze Scan";
				ZXing.Result scanResult = QrCodeWrapper.DecodeImage(scan);
				string result = scanResult.Text;
				if(result != null){
					myDebug.text = "Scan Found";
					myContent = result;
					hasFound = true;
				}
			}
			yield return new WaitForSeconds(ScanDelay);
		}
		myDebug.text = "Scan Ended";
		myWrapper.StartCamera();
		myDebug.text = "Camera Restarted";
		myStartSearch.isOn = false;
		myDebug.text = "Disabling Search Button";
		myText.text = myContent;
		myDebug.text = "Disabling Scan";
		isScanning = false;
		yield return null;
	}

}
